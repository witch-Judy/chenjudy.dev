---
import type { GetStaticPaths } from "astro";
import { getCollection } from "astro:content";
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Card from "@/components/Card.astro";
import Pagination from "@/components/Pagination.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import { SITE } from "@/config";

export const getStaticPaths = (async ({ paginate }) => {
  const posts = await getCollection("blog", ({ data }) => !data.draft);
  return paginate(getSortedPosts(posts), { pageSize: SITE.postPerPage });
}) satisfies GetStaticPaths;

const { page } = Astro.props;

// Get ALL posts for category filtering (not just current page)
const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const sortedAll = getSortedPosts(allPosts);

const notesPosts = sortedAll.filter(p => (p.data.category || "notes") === "notes");
const collectionsPosts = sortedAll.filter(p => p.data.category === "collections");
---

<Layout title={`Posts | ${SITE.title}`}>
  <Header />
  <Main pageTitle="Posts" pageDesc="All the articles I've posted.">
    <div class="mb-6 flex gap-4 border-b border-border" id="category-tabs">
      <button
        class="category-tab active-tab pb-2 font-medium text-accent border-b-2 border-accent"
        data-tab="notes"
        data-lang-en={`Notes (${notesPosts.length})`}
        data-lang-zh={`手记 (${notesPosts.length})`}
      >
        {`Notes (${notesPosts.length})`}
      </button>
      <button
        class="category-tab pb-2 font-medium text-foreground/50 hover:text-foreground/80"
        data-tab="collections"
        data-lang-en={`Collections (${collectionsPosts.length})`}
        data-lang-zh={`收藏 (${collectionsPosts.length})`}
      >
        {`Collections (${collectionsPosts.length})`}
      </button>
    </div>

    <ul id="notes-list">
      {notesPosts.length > 0 ? (
        notesPosts.map(data => <Card {...data} />)
      ) : (
        <p class="text-foreground/50 italic" data-lang-en="No notes yet." data-lang-zh="还没有手记。">No notes yet.</p>
      )}
    </ul>

    <ul id="collections-list" class="hidden">
      {collectionsPosts.length > 0 ? (
        collectionsPosts.map(data => <Card {...data} />)
      ) : (
        <p class="text-foreground/50 italic" data-lang-en="No collections yet." data-lang-zh="还没有收藏。">No collections yet.</p>
      )}
    </ul>
  </Main>

  <Footer />
</Layout>

<script>
  function initTabs() {
    const tabs = document.querySelectorAll<HTMLButtonElement>(".category-tab");
    const notesList = document.getElementById("notes-list");
    const collectionsList = document.getElementById("collections-list");

    if (!tabs.length || !notesList || !collectionsList) return;

    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        const target = tab.dataset.tab;

        tabs.forEach(t => {
          t.classList.remove("active-tab", "text-accent", "border-b-2", "border-accent");
          t.classList.add("text-foreground/50");
        });
        tab.classList.add("active-tab", "text-accent", "border-b-2", "border-accent");
        tab.classList.remove("text-foreground/50");

        if (target === "notes") {
          notesList.classList.remove("hidden");
          collectionsList.classList.add("hidden");
        } else {
          notesList.classList.add("hidden");
          collectionsList.classList.remove("hidden");
        }
      });
    });
  }

  initTabs();
  document.addEventListener("astro:after-swap", initTabs);
</script>
